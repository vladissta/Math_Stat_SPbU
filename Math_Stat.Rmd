---
title: 'Math statistcis '
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 1
    keep_md: true
    latex_engine: xelatex
    includes:
      in_header: header.tex
---

```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(car)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggnewscale)
library(kableExtra)
```

# Case A

### Данные (первые 6 значений)
```{r, echo=F}
student_grades = read.csv('data/case_a.txt', col.names = c("Student","grade_1st_period", "grade_2nd_period")) |>  head()
```

```{r, echo=F}
student_grades |> knitr::kable(align = "c") |> row_spec(0,bold=TRUE) |>  kable_styling(full_width = T, )
```

```{r, echo=F}
student_grades = student_grades |> 
  pivot_longer(cols=c("grade_1st_period", "grade_2nd_period"), values_to = 'Grade', names_to = 'Period')

```

<!-- ### Гистограмма -->

<!-- ```{r fig.height=3, fig.width=5, echo=F} -->
<!-- ggplot(data = student_grades, aes(x=Grade, fill=Period)) + geom_histogram(alpha=0.7, binwidth = 5) + -->
<!--   scale_fill_discrete(labels = c("1st period", "2nd period")) + theme_bw() -->
<!-- ``` -->


**(a) Гипотезы:**   
- $H_0$ - средняя оценка студентов за первый период **не отличается** от средней оценки за второй период  
- $H_A$ - средняя оценка студентов за первый период **меньше** средней оценки за второй период  

**(b)** Зависимой переменной является **оценка студента**, так как задачей программы было именно изменение оценок студентов к лучшему

**(c)** В данном случае оценка студента - данные измеренные в относительной шкале оценок, то есть уровень измерения - относительный (**ratio scale level**)

**(d)** Дизайн эксперимента заключался в измерении показателя до "воздействия" и после него (**pretest-posttest design**). В данном случае были получены данные об оценках студентов в первом периоде аттестации (то есть **до** начала проекта по улучшению оценок) и во втором периоде аттестации, то есть **после** запуска проекта.

**(e)** Лучшим решением будет проверить одностороннюю гипотезу парным Т-тестом, так как  
  1. Данные **ДО** и после **ПОСЛЕ** являются зависимыми, потому что измерены у одних и тех же студентов.  
  2. Хотим проверить гипотезу о неравенстве средних оценок студентов  

**(f)** Т-тест используется для определения того, есть ли статистиечески значимая разница между средними показателями двух групп. В данном случае две группы - это оценки студентов за первый период и за второй период. Мы проверяем одностороннюю гипотезу, поэтому тестируется *больше ли* полученное значение статистики, чем некоторое критическое значение, при котором мы можем отвергнуть нулевую гипотезу ($p{-}value \leq 0.05$).

### Paired t-test

```{r}
ttest = t.test(student_grades$Grade[student_grades$Period == 'grade_1st_period'],
               student_grades$Grade[student_grades$Period == 'grade_2nd_period'], 
               paired=TRUE, alternative='less')
```

```{r, echo=FALSE}
data.frame(`t-statistic`=ttest$statistic, `p-value`=ttest$p.value, row.names = NULL) |>
  knitr::kable(align = 'c')
```

**(g)** ДА. Значение статистики и соответствующий *p-уровень значимости* указывает на то, что мы не можем отклонить альтернативную гипотезу о том, что средние оценки студентов за первый и второй период отличаются.

**(h)** Это означает, что проект по улучшению оценок студентов прошел успешно. Средняя оценка студентов изменилась в большую сторону за второй период аттестациию.

# Case B

### Данные (первые 12 значений)

```{r,echo=FALSE}
wolves = read.table('data/InbreedingWolves.csv', sep=';', header = T, 
                    col.names = c('Inbreeding Coefficient', 'Nember of Puppies'))
wolves |> head(12) |> knitr::kable(align = "c") |> row_spec(0,bold=TRUE) |> kable_styling(full_width = T)
```

### **(a)** Изобразить графически:
<!-- #### Гистограммы -->

<!-- ```{r fig.height=4, fig.width=7, echo=FALSE} -->
<!-- par(mfrow = c(1, 2)) -->

<!-- hist(wolves$inbreeding.coefficient, breaks = seq(0,0.5,0.05),  -->
<!--      xlab = 'Inbreeding coefficient', main = NULL) -->
<!-- hist(wolves$pups, breaks = seq(0,8), xlab = 'Number of puppies', main = NULL) -->

<!-- par(mfrow = c(1, 1)) -->
<!-- ``` -->

```{r fig.height=4, fig.width=4, echo=FALSE}
plot(wolves$Inbreeding.Coefficient, wolves$Nember.of.Puppies, 
     xlab = "Inbreeding coefficient", ylab = 'Number of puppies', pch=16)
```

Виден такой тренд, что при увеличении коэффициента инбридинга уменьшается количество щенят.

### **(b)** Вычислить корреляцию

```{r}
cor(wolves$Inbreeding.Coefficient, wolves$Nember.of.Puppies)
```

Корреляция между коэффициентом инбридинга и количеством щенят равна **~ -0.61**, что указывает на умеренную **отрицательную корреляцию** между показателями. Это говорит о том, что в основном при увеличении коэффициента инбридинга, количество щенят снижается.

### **(c)** Гипотезы для тестирования
- $H_0$: корреляция = 0
- $H_A$: корреляция $\neq$ 0

Используем **Т-тест** Стьюдента  

```{r}
crtest = cor.test(wolves$Inbreeding.Coefficient, wolves$Nember.of.Puppies)
```

```{r, echo=FALSE}
data.frame(`t-statistic`=crtest$statistic, `p-value`=crtest$p.value, row.names = NULL) |>
  knitr::kable(align = 'c')
```

Таким образом, результаты теста не позволяют отвергнуть альтернативную гипотезу, что корреляция между коэффициентом инбридинга и количеством щенят не равна нулю (она равна **-0.61**). 

# Case C

### Данные 

```{r, echo=FALSE}
patients_df = read.csv('data/case_c.txt')
patients_df |> knitr::kable(align = "c") |> row_spec(0,bold=TRUE) |> kable_styling(full_width = T)
```

**(a) Гипотезы:**  
- $H_0$ - соотношения количества пациентов, соблюдающих и несоблюдающих режим приема лекарств, в первый день и через месяц после визитов социального работника **равны**  
- $H_A$ - соотношения количества пациентов, соблюдающих и несоблюдающих режим приема лекарств, в первый день и через месяц после визитов социального работника **не равны**  

**(b)** Зависимой переменной является **соблюдение режима приема лекарств пациента** (*соблюдает или нет*), так как именно это стремится изменить программа - чтобы те, кто не соблюдал режим, стали его соблюдать.

**(c)** Соблюдение режима приема лекарств пациента - номинальные данные (**nominal level**). Есть только две категории - соблюдает режим и не соблюдает. 

**(d)** Дизайн эксперимента - измерение до "воздействия" (регулярных визитов соц.работника в течение месяца) и после него (**pretest-posttest design**). В данном случае каждому пациенту ставится в соответсвие категория соблюдения режима принятия лекарств в самом начале программы и через месяц. 

**(e)** Структура данных представляет собой таблицу с информацией о соблюдении пациентами режима принятия лекарств в начале и через меясц работы медицинской программы. В таблице каждая строка соответствует пациенту, а столбцы - измерения при первом посещении и через месяц. Значения в таблице - бинарная переменная: соблюдает или не соблюдает.
**Данные можно представить в виде таблицы сопряженности:**  

```{r, echo=FALSE}
data = table(patients_df$first.meeting, patients_df$One.month.later) 
dimnames(data) = list(c("Compliant_first.day", "Non-compliant_first.day"),
                    "    After month" =c("Compliant_after.month", "Non-compliant_after.month"))
data |> knitr::kable(align = 'c')
```

**(f)** Так как данные *в первый день* и *через месяц* зависимые, то применить обычный тест Хи-квадрат нельзя, поэтому для такого случая зависимых данных вопсользуемся **McNemar test** *(с континуальной поправкой Yates)*

```{r}
mctest = mcnemar.test(data)
```

```{r, echo=F}
data.frame(`McNemar_chi_squared`=mctest$statistic, `p-value`=mctest$p.value, row.names = NULL) |>
  knitr::kable(align = 'c')
```

**(g)** НЕТ

**(h)** Результаты теста не позволяют отвергнуть нулевую гипотезу о том, что доля соблюдающих режим приема лекарств пациентов изменилась. Часть пациентов, действительно стали соблюдать режим. Однако есть и те, кто как соблюдал/не соблюдал, так и продолжил соблюдать/не соблюдать режим. Также есть и пациент, который наоборот перестал соблюдать режим.  

Таким образом, можно поставить под сомнение эффективность данной медицинской программы.

# Case D

### Данные (только 6 значений)
```{r, echo=F}
mice = read.csv('data/MouseEmpathy.csv', stringsAsFactors = T, 
                col.names = c('condition', "stretch", "treatment"))
mice$condition = factor(mice$condition, levels = c('Isolated', 'OneWrithing', 'BothWrithing'))

mice[c(1,2,16,17,40,41),1:2] |>  head() |> knitr::kable(align = "c", row.names = F) |>
  row_spec(0,bold=TRUE) |> 
  kable_styling(full_width = T)
```

### **(a)** Полная модель:

$y =  \beta_1 I_{ow} + \beta_2 I_{bw} + \beta_0$, где  

- $y$ - переменная отклика, процент времени, в течение которого мышь демонстрировала *поведение растягивания*, то есть испытывала дискомфорт(**stretch**),  
- $I_{ow}$ - идндикатор (*dummy variable*), принимающий значение 1, если мышь была помещена к  мыши-компаньону, которой не делали инъекций, и 0 в противном случае (**BothWrithing**)
- $I_{bw}$ - идндикатор (*dummy variable*), принимающий значение 1, если мышь была помещена к  мыши-компаньону, которой также была сделана инъекция, и 0 в противном случае (**OneWrithing**)
- $\beta_0$ - базовое значение, средний процент времени дискомфорта для **изолированных** мышей,  
- $\beta_1$ - коэффициент для $I_{ow}$, разница в среднем проценте времени дискомфорта между мышами, помещенными с **неинъецированным компаньоном** и изолированными мышами,  
- $\beta_2$  - коэффициент для $I_{bw}$, разница в среднем проценте  времени дискомфорта между мышами, помещенными с **инъецированным компаньоном** и изолированными мышами,  
<!-- - $\epsilon$ - ошибка, случайная вариация. -->


```{r}
full_model = lm(stretch ~ condition, data = mice)
summary(full_model)
```

### **(b)** Нулевая модель:

В нулевой моедли мы предполагаем, что **разницы** в проценте времени дискомфорта между тремя группами мышей (изолированных, помещенных с неинъецированным компаньоном и помещенных с инъецированным компаньоном) **нету**:

$y = \beta_0$, где  

- $\beta_0$ - базовое значение, средний процент времени дискомфорта  

```{r}
null_model = lm(stretch ~ 1, data = mice)
summary(null_model)
```

### **(c)** График

```{r, echo=FALSE}
condition_lvls = levels(mice$condition) |>  list()
names(condition_lvls) = 'condition'
```


```{r, echo=FALSE}
predicted_full = predict(full_model, newdata = condition_lvls)  |> data.frame() 
colnames(predicted_full) = c("stretch")
predicted_full = predicted_full |> cbind(list("condition" = c('Isolated', 'OneWrithing', 'BothWrithing')))

predicted_null = predict(null_model)[1:3]  |> data.frame() 
colnames(predicted_null) = c("stretch")
predicted_null = predicted_null |> cbind(list("condition" = c('Isolated', 'OneWrithing', 'BothWrithing')))
```


```{r fig.height=4, fig.width=7, echo=FALSE}
ggplot(mice, aes(x= condition, 
                 y=stretch, col=condition)) + 
  geom_point(position = position_nudge(x = 0.05)) +
  labs(colour = 'Condition') +
  ggnewscale::new_scale_colour() +
  geom_point(data = predicted_full,
             aes(y=stretch,
                 x=condition, col='Full'),
              cex=3, alpha=.8, pch = 17,
             position = position_nudge(x=-0.05)) +
  geom_path(data = predicted_full, group=1,
             aes(y=stretch,
                 x=condition),
             col='red', alpha=.8,
             position = position_nudge(x=-0.05)) +
  geom_point(data = predicted_null,
             aes(y=stretch,
                 x=condition, col='Null'),
             cex=3, alpha=.8, pch = 15,
             position = position_nudge(x=-0.05)) +
  geom_path(data = predicted_null, group=1,
             aes(y=stretch,
                 x=condition),
             col='blue', alpha=.8,
             position = position_nudge(x=-0.05)) + 
  scale_colour_manual(values = c('Full' = 'red', 'Null' = 'blue')) +
  labs(colour = 'Model', y='Stretch', x='Condition') + theme_bw()

```

В полной модели наблюдатеся такой паттерн, что **мышь "эмпатична"**, то есть процент времени дискомфорта увеличивается, если мышь-компаньон тоже поддверглась инъекции.

### **(d)** Статсистически протестируем  полную модель
То есть сравним ее с нулевой.  
Для этого хорошо подойдет F-статистика (*ANOVA*):

```{r}
F_test = anova(full_model, null_model)
```

```{r, echo = FALSE}
data.frame(`F_statistic`=F_test$F[2], `p-value`=F_test$`Pr(>F)`[2], row.names = NULL) |>
  knitr::kable(align = 'c')
```

Таким образом, результаты теста позволяют отвергнуть нулевую гипотезу, что **разницы** в проценте времени дискомфорта между тремя группами мышей (изолированных, помещенных с неинъецированным компаньоном и помещенных с инъецированным компаньоном) **нету**. Мы принимаем альтернативную гипотезу, что **разница есть**.

### Проведем пост-хок тест
Пост-хок тест проводим, чтобы узнать, какая группа мышей статистически значимо отличетася от остальных - то есть статистически значимо отличается средний процент времени дискомфорта.
Для этого воспользуемся тестом Тьюки:

```{r}
Tu_test = TukeyHSD(aov(stretch ~ condition, data=mice))
```

```{r, echo=F}
Tu_test$condition |> knitr::kable() 
```

Из результатов теста видно, что группа, где мышь была помещена к  мыши-компаньону, которой также была сделана инъекция, статистически значимо отличется от остальных.  

*Скорректированный p-уровень значимости* в сравнениях **Изолированная vs. С инъецированным компаньоном** и **С НЕинъецированным компаньоном vs. С инъецированным компаньоном** оказался менее 0.05. Это означает, что среднее время дискомфорта в сравниваемых группах статичстически значимо отличается.

Процент времени *дискомфорта* в случае, когда обеим мышам была сделана инъекция, больше примерно на ~21% чем в случаях, когда мышь была изолирована или когда компаньону не была сделана инъекция. 

**Таким образом, действительно тестируемые мыши были более эмпатичны и время их *дискомфорта* было больше, если вторая мышь так же "страдала"**.

<!-- # Case E -->
<!-- https://varmara.github.io/glmintro/4.2_model_selection.html -->

<!-- ### Данные (первые 6 значений) -->

<!-- ```{r} -->
<!-- prostate = read.table("prostate.data")  -->
<!-- # |>  mutate(svi = as.factor(svi)) -->
<!-- prostate |> head() |>  knitr::kable() -->
<!-- ``` -->

<!-- ### **(a)** Корреляция между показателями -->

<!-- ```{r fig.height=4, fig.width=5} -->
<!-- library(pheatmap) -->

<!-- cor(prostate) |> pheatmap( -->
<!--                           # cluster_rows = F, cluster_cols = F,  -->
<!--                           display_numbers = T, main = 'Correlation') -->

<!-- # cor(prostate[sapply(prostate, is.numeric)]) |>  -->
<!--   # pheatmap(cluster_rows = F, cluster_cols = F, display_numbers = T) -->
<!-- ``` -->

<!-- ## **(b)** Составим несколько моделей -->

<!-- ```{r} -->
<!-- lm(lpsa ~ ., data=prostate |>  mutate(svi = as.factor(svi))) |> summary() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- ``` -->

# Case F

### Данные
```{r, echo=F}
anxiety = data.frame(week=c(0:6),anxiety=c(34,31,28,33,35,29,28))
anxiety |> knitr::kable() |> row_spec(0,bold=TRUE)
```

**Week 0 $\equiv$ Baseline**

<!-- ```{r, echo=F, fig.width=4, fig.height=4} -->
<!-- plot(anxiety, pch=19) -->
<!-- ``` -->


**(a)** Гипотеза состоит в том, что значение тревожности девушки уменьшалось с течением времени. В случае верности гипотезы можно будет говорить об эффективности терапии.

**(b)** Зависимой переменной является значение тевожности, так как именно это значение в процессе терапии девушка стремится уменьшить.

**(c)** В данном случае значение тревожности измерялось в относительной шкале, то есть уровень измерения - относительный (**ratio scale level**)

**(d)** В исследовании исследовалось изменение показателя тревожности со временем - в течение нескольких недель. Такие исследования называют **лонгитюдными** (**longitudinal research design**).

**(e)** Чтобы изучить изменение тревожности со временем, подберем модель линейной регресии, где зависимая переменная *тревожность*, а независимая - время (номер недели)  
$anxiety = \beta_1 * week + \beta_0$  
Сравним эту модель с нулевой моделью, где уровень тревожности будет одинаковым (средним) на протяжнии всего времени  
$anxiety = \beta_0$  
Таким образом, мы хотим проверить есть ли какой-то тренд в значении тревожности со временем. То есть проверяем значимо ли статистически коэфициент ($\beta_1$) при номере недели ($week$) отличен от нуля.
Для этого используем **F-статистику**

**(f)** F-статистика используется для сравнения степени соответствия между полной и нулевой моделями в регрессионном анализе. F-статистика рассчитывается, как отношение средней квадратичной ошибки нулевой модели на среднюю квадратичную ошибку полной модели. Полученное значение сопостовляется с F-распределением со степенями свободы, равными разнице количества коэффициентов моделей. Если полученная статистика больше критического значения, мы отвергаем нулевую гипотезу о том, что полная модель не обеспечивает лучшего соответствия, чем нулевая модель. То есть мы делаем вывод, что полная модель лучше соответствует данным, чем нулевая модель.


### Модели:
```{r}
full = lm(anxiety ~ week, data=anxiety) 
null = lm(anxiety ~ 1, data=anxiety)
```

### F-тест
```{r}
F_test = anova(full,null)
```

```{r, echo=F}
data.frame(`F-statistic`=F_test$F[2], `p-value`=F_test$`Pr(>F)`[2], row.names = NULL) |>
  knitr::kable(align = 'c')
```

**(g)** НЕТ. Полученные результаты теста не позвляют отвергнуть нуевую гипотезу о том, что средний уровень тревожности в течение нескольких недель был одинаков. Действительно, из данных было видно, что в течение шести недель тервожность девушки и поднималась и понижалась примерно в равной степени. 

**(h)** Таким образом, можно говорить о неэффективности терапии, которую получает девушка. Уровень тревожности в среднем остается не изменяется с течением времени, что было показано статистически.


